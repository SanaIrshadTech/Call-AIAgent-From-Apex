**AgentForce Integration in Apex**

**ğŸ“Œ Overview**
This project demonstrates how to call an AgentForce Default (formerly Einstein Copilot) from Apex and display the response in Lightning Web Components (LWC).
With the Spring â€™25 Release, Salesforce now allows Flow and Apex to call AgentForce Service Agents (ASA) or the default AgentForce agentâ€”bringing AI-driven automation beyond chat and into core business logic.

**Why This Matters?**
Previously, agents could invoke Salesforce Flow or Apex components, but now, **the reverse is also possible**:

&ensp;ğŸ”¹ Apex â€“ Developers can leverage agents' topics, actions, and reasoning capabilities beyond the chat boxâ€”directly within Apex code using custom agent invocable actions.

&ensp;ğŸ”¹ Flow â€“ Calling agents in Flow is another significant step in extending their functionality beyond the chat window.

[ğŸ“– Read the Salesforce Help Article](https://help.salesforce.com/s/articleView?id=release-notes.rn_einstein_agent_flow_apex.htm&release=254&type=5)

**ğŸ’¡ How It Works**

**âœ… Invoking the Agent from Apex**
Apex method to trigger AgentForce AI and retrieve structured responses:
```apex
Invocable.Action action = Invocable.Action.createCustomAction(
    'generateAiAgentResponse', 'Copilot_for_Salesforce_883102392728379'
);
action.setInvocationParameter('userMessage', userPrompt);
action.setInvocationParameter('sessionId', agentSessionId);
List<Invocable.Action.Result> resultList = action.invoke();
```
**âœ… Processing Responses in LWC**
The LWC (caseDashboardLwc) component processes the respose generated by AI Agent and displays it on UI:
```javascript
getAgentActionMethod({userPrompt: this.userPrompt, agentSessionId: this.agentSessionId})
.then(result => {
    if(result.isSuccess) {
        this.welcomeMessage = result.value;
    }
})
.catch(error => {
    this.showToast('Error', error, 'error');
});
```

**ğŸ“Œ Maintaining a Session ID While Calling an Agent from Apex**
By default, if you do not set the session ID parameter, a new session ID is created for every interaction. This means the agent does not retain context from previous interactions.

Steps to Maintain Context:

&ensp;âœ”ï¸ Retrieve the session ID from the first invocation.

&ensp;âœ”ï¸ Set the session ID in subsequent calls:

```apex
action.setInvocationParameter('sessionId', 'your_existing_session_id');
```

**ğŸ“Œ Testing Session ID Behavior: Video Demo**
ğŸ‘‰ Check the video below to see how the Session ID affects agent behavior.
Problem statement â€“ Retrieve the list of cases assigned to a specific owner through Agentforce agent.
Steps Involved:

**ğŸ”¹ When Session ID is Not Provided:**

  1.	Commented out the setting of the Session ID during agent action invocation.

  2.	Calling an Apex method (invoking AgentForce default) from the anonymous window:

    After Prompt 1, the agent asks for the Owner ID or Name.

    After providing the Owner ID in Prompt 2, a new session starts (since the Session ID is not set).

    As a result, the agent loses context of the initial request for cases assigned to the owner. Instead, it detects a new intent and calls the Summary Record Agent Action instead of listing the cases.

**ğŸ”¹ When Session ID is Set During Agent Invocation:**

1.	Uncommented the code to set the Session ID while invoking the agent.

2.	Calling an Apex method for the same two prompts from the anonymous window:

  &emsp;Since the agent remembers the context of previous interactions, simply passing the Owner ID in the second call allows the agent to correctly return the list of cases associated with the provided Owner ID.

**ğŸ”¥ Built and Tested a Quick Use Case: Calling Agent from Apex**

I developed and tested code to call AgentForce Default (formerly Einstein Copilot) from Apex in a new Developer org with AgentForce and Data Cloud features, performing tasks such as:

&emsp;âœ… Call an AgentForce AI agent from Apex using Invocable.Action

&emsp;âœ… Fetch cases based on the owner

&emsp;âœ… Identify new or escalated cases related to a contact

&emsp;âœ… Maintain Agent Session ID for conversational continuity

&emsp;âœ… Provide a welcome message to a Service Rep

&emsp;âœ… Display AI responses, including a heads-up count of cases in LWC UI

**ğŸ› ï¸ Tech Stack**

&emsp;ğŸ”¹ Salesforce Apex (Invocable Agent Actions)

&emsp;ğŸ”¹ Lightning Web Components (LWC)

**ğŸ“ Project Structure**

``` none
|-- force-app/main/default/
    |-- classes/
        |-- AIAgentInvokerController.cls
        |-- AIAgentInvokerController.cls-meta.xml
    |-- lwc/
        |-- caseDashboardLwc/
            |-- caseDashboardLwc.html
            |-- caseDashboardLwc.js
            |-- caseDashboardLwc.js-meta.xml
```

**âš¡ Installation & Setup**

&ensp;ğŸ”¹ Clone the repository:
```none
git clone https://github.com/your-repo-url.git
cd your-repo
```
&ensp;ğŸ”¹ Deploy the metadata to Salesforce:

```none
sfdx force:source:push -u <your-org-alias>
```

&ensp;ğŸ”¹ Assign Permissions: Ensure the user has access to the Apex controller associated with the LWC.

&ensp;ğŸ”¹ Test the Agent Invocation in LWC UI.

**ğŸ–¥ï¸  Usage**

Since the LWC component is exposed to Lightning Record Page, App Page, Tab, and Utility Bar, you can add it to any of these places to test the functionality from the UI.

&ensp;**ğŸ“Œ Demo Setup:**

&emsp;â€¢	I created a separate App: "Support Lense"

&emsp;â€¢	Added the "Case Navigator" tab

&emsp;â€¢	The LWC component imperatively calls the Apex method to invoke AgentForce

**ğŸ”® Future Enhancements**

&ensp;ğŸ”¹ AI-powered case summarization

&ensp;ğŸ”¹ Agent-driven case modifications

&ensp;ğŸ”¹ Automated email drafts using AI

**ğŸ“Œ AgentForce Metadata Deployment**

To deploy AgentForce AI across Salesforce orgs, you need to deploy key GenAI metadata components:

&ensp;ğŸ”¹ GenAiPlanner â€“ Configures the AI agentâ€™s reasoning engine.

&ensp;ğŸ”¹ GenAiPlugin â€“ Stores topics associated with AI agents.

&ensp;ğŸ”¹ GenAiFunction â€“ Stores agent action details for respective topics.

&ensp;ğŸ”¹ GenAiPromptTemplate â€“ Stores prompt templates for AI interactions.

Refer to the Salesforce Metadata API Developer Guide for details.

**ğŸ“œ License**
**ğŸ¤ Contributing**
**ğŸ“§ Contact: **
For any questions or support, please contact sfdcchampsa@gmail.com
